name: Deploy Fullstack to QA (Self-Hosted)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: 🧹 Clean old frontend/backend folders
        run: |
          echo "Cleaning /var/www folders"
          sudo rm -rf /var/www/admin-panel
          sudo rm -rf /var/www/ya-wealth
          
      - name: Who am I
        run: whoami

      - name: 📁 Create /var/www folders and set permissions
        run: |
          sudo mkdir -p /var/www/admin-panel
          sudo mkdir -p /var/www/ya-wealth
          sudo chown -R $USER:$USER /var/www

      - name: ⬇️ Clone Backend Repo (ya-wealth)
        run: |
          git clone https://github.com/finariotech07/ya-wealth.git /var/www/ya-wealth

      - name: ⬇️ Clone Frontend Repo (admin-panel)
        run: |
          git clone https://github.com/finariotech07/admin-panel.git /var/www/admin-panel

      - name: ⚙️ Install & Build Backend
        run: |
          cd /var/www/ya-wealth
          sudo npm install
          sudo npm run build || true

      - name: 🚀 Start Backend with PM2
        run: |
          cd /var/www/ya-wealth
          sudo pm2 delete ya-wealth || true
          sudo pm2 start npm --name ya-wealth -- run start

      - name: ⚙️ Install & Build Frontend
        run: |
          cd /var/www/admin-panel
          sudo npm install
          sudo npm run build

      - name: 🚀 Start Frontend with PM2
        run: |
          cd /var/www/admin-panel
          sudo pm2 delete admin-panel || true
          sudo pm2 start npm --name admin-panel -- run start
